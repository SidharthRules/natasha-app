<!DOCTYPE html>
<head>
	<title>Natasha App</title>
	<link rel="stylesheet" href="css/icon.css">
	<link rel="stylesheet" href="css/material.indigo-pink.min.css">
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
	<script src="js/material.min.js"></script>
	<link rel="stylesheet" type="text/css" href="css/pignose.calendar.min.css" />
	<script type="text/javascript" src="js/jquery-2.2.4.min.js"></script>
	<script type="text/javascript" src="js/moment.min.js"></script>
	<script type="text/javascript" src="js/pignose.calendar.min.js"></script>
	<script type="text/javascript" src="js/plotly-latest.min.js"></script>
	<style type="text/css">
		body{
			background-color: #f5f5f5; 
		}
		.wid90{
			width: 90%!important;
		}
		.page-content{
			padding: 10px!important;
   			}
   		@media screen and (max-width: 1024px){
   			.mdl-layout__header .mdl-layout__drawer-button {
		    margin: 7px!important;
		   }
		    #quickCommand {display: none};	
   		}
   		.mdl-button{
   			margin: 10px!important;
   		}
   		.demo-card-wide.mdl-card {
		  width: 90%;
		}
		.demo-card-wide > .mdl-card__title {
		  color: #fff;
		  height: 176px;
		  background: url('img/bg1.png') center / cover;
		}
		.demo-card-wide > .mdl-card__menu {
		  color: #fff;
		}
		.menuImg{
			width: 100px;
			padding: 10px;
		}
		.mdl-card{
			min-height: 50px;
		}
		.modebar
		{
			display: none!important;
		}
		.myLoader, #tabData, #tabSchedule{
			display: none;
		}
		.profile-square.mdl-card {
		  width: 280px;
		  height: 320px;
		}
		.profile-square > .mdl-card__title {
		  color: #fff;
		  background:
		    url('img/profile.png') bottom right 15% no-repeat #46B6AC;
		   background-size: 280px 280px;
		}
		.calories-square.mdl-card {
		  width: 280px;
		  height: 320px;
		}
		.calories-square > .mdl-card__title {
		  color: #fff;
		  background:
		    url('img/food.png') bottom right 15% no-repeat #46B6AC;
		  background-size: 280px 280px;
		}
		.power-square.mdl-card {
		  width: 280px;
		  height: 320px;
		}
		.power-square > .mdl-card__title {
		  color: #fff;
		  background:
		    url('img/power.png') bottom right 15% no-repeat #46B6AC;
		    background-size: 280px 280px;
		}
		.chat-square.mdl-card {
		  width: 280px;
		  height: 320px;
		}
		.chat-square > .mdl-card__title {
		  color: #fff;
		  background:
		    url('img/chat.png') bottom right 15% no-repeat #46B6AC;
		    background-size: 280px 280px;
		}
		#welcome{
			background: rgba(0, 0, 0, 0.5);
			padding: 0px 10px 0px 10px;
    		border-bottom-right-radius: 10px;
		}
		#mySchedule select{
			min-height: 40px;
		    font-size: 20px;
		    padding: 5px;
		    margin-bottom: 10px;
		    border-top: none;
		    border-left: none;
		    border-right: none;
		    border-color: #3f51b5;
		}
		#mySchedule select:focus{
			outline: none;
		}
 	</style>
 	<script type="text/javascript">
	//<![CDATA[
	var stDate="",enDate="";
	$(function() {
		function onClickHandler(date, obj) {
			/**
			 * @date is an array which be included dates(clicked date at first index)
			 * @obj is an object which stored calendar interal data.
			 * @obj.calendar is an element reference.
			 * @obj.storage.activeDates is all toggled data, If you use toggle type calendar.
			 */

			var $calendar = obj.calendar;
			var $box = $calendar.parent().siblings('.box').show();
			var text = 'Date:  ';

			if(date[0] !== null) {
				text += date[0].format('YYYY-MM-DD');
				stDate = date[0].format('YYYY-MM-DD');
			}

			if(date[0] !== null && date[1] !== null) {
				text += ' ~ ';
			} else if(date[0] === null && date[1] == null) {
				text += 'nothing';
			}

			if(date[1] !== null) {
				text += date[1].format('YYYY-MM-DD');
				enDate = date[1].format('YYYY-MM-DD');
			}

			$box.text(text);
		}

		// Multiple picker type Calendar
		$('.calendar').pignoseCalendar({
			multiple: true,
			select: onClickHandler
		});
	});
	//]]>
	</script>
</head>

<body>
	<!-- Always shows a header, even in smaller screens. -->
	<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
	  <header class="mdl-layout__header">
	    <div class="mdl-layout__header-row">
	      <!-- Title -->
	      <span class="mdl-layout-title">Project Natasha</span>
	      <!-- Add spacer, to align navigation to the right -->
	      <div class="mdl-layout-spacer"></div>
	      <form action="#" id="quickCommand" onsubmit="handle">
	      	<div id="hpan" class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
			    <input class="mdl-textfield__input" type="text" id="ip">
			  	<label class="mdl-textfield__label" for="roll" style="color:#fff;">Command Directly From here</label>
			</div>
		  </form>
	     </div>
	  </header>
	  <div class="mdl-layout__drawer">
	    <span class="mdl-layout-title">Project Natasha</span>
	    <nav class="mdl-navigation">
	      <a class="mdl-navigation__link" id="logout">Logout</a>
	    </nav>
	  </div>
	  <main class="mdl-layout__content">
	    <div class="page-content">
	    	<!-- Accent-colored raised button with ripple -->
	    	<center>
	    		<div class="demo-card-wide mdl-card mdl-shadow--2dp">
				  <div class="mdl-card__title">
				    <h2 class="mdl-card__title-text" id="welcome"></h2>
				  </div>
				  <div class="mdl-card__supporting-text" id="myText">
				  	AI powered Smart Home Automation
				  </div>				  
				</div>

				
				<div class='mdl-grid mdl-card wid90 mdl-shadow--2dp' style="margin-top:10px; padding: 10px;">
					 	<div class="mdl-cell mdl-cell--4-col">
					 		<div class="calendar"></div>
							<div class="box" style="padding: 5px;"></div>	
							<button id="graph" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored wid90">Show Consumption Details</button>
					 	</div>
					 	<div class="mdl-cell mdl-cell--8-col">
					 		<div class="myLoader" style="padding:10px;">
		    					<img src='img/cube.gif'/>
		    					<h1>Loading ...</h1>
		    				</div>
		    				<div id="stats" style="overflow-x:auto;">
						 		<h1>Choose the Date/Range</h1>
						 		<h2>To Show Power Consumption Details</h2>
					 		</div>
					 	</div>
					</div>
				
				 <div class="demo-card-wide mdl-card mdl-shadow--2dp wid90" id= "tabData" style="overflow-x:auto;margin-top:10px; padding: 10px;">
				 	<h3 >Power Consumpition Detailed Table</h3>
				 	<table class="mdl-data-table mdl-js-data-table" style="width:100%;">
						<thead>
						   	<tr>
							   <th class="mdl-data-table__cell--non-numeric">Date</th>
							   <th class="mdl-data-table__cell--non-numeric">Device</th>
							   <th class="mdl-data-table__cell--non-numeric">Start</th>
							   <th class="mdl-data-table__cell--non-numeric">Stop</th>
							   <th class="mdl-data-table__cell--non-numeric">Total</th>
							</tr>
						</thead>
								  <tbody id="myTable1">
								  </tbody>
					</table>
				 </div>
				<div class='mdl-grid mdl-card wid90 mdl-shadow--2dp' style="margin-top:10px; padding: 10px;">
			 		<div class="mdl-cell mdl-cell--5-col" id="mySchedule" >
			 				<select name="dev" id="sid" class="wid90">
							  <option value="lone">1st Light</option>
							  <option value="ltwo">2nd Light</option>
							  <option value="fone">1st Fan</option>
							  <option value="ftwo">2nd Fan</option>
							  <option value="pump">Pump</option>
							</select> <br/>
							<select name="devStat" id="devSt" class="wid90">
							  <option value="ON">Turn On</option>
							  <option value="OFF">Turn Off</option>
							</select> <br/>
							<select name="days" id="day" class="wid90">
							  <option value="mon">Monday</option>
							  <option value="tue">Tuesday</option>
							  <option value="wed">Wednesday</option>
							  <option value="thur">Thursday</option>
							  <option value="fri">Friday</option>
							  <option value="sat">Saturday</option>
							  <option value="sun">Sunday</option>
							  <option value="all">Everyday</option>
							</select> <br/>
							<div id="hpan" class="wid90 mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
							    <input class="mdl-textfield__input" type="text" id="schedule_start">
							  	<label class="mdl-textfield__label" for="schedule_start">Start Time (hh:mm)</label>
							</div>
							<div id="hpan" class="wid90 mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
							    <input class="mdl-textfield__input" type="text" id="schedule_end">
							  	<label class="mdl-textfield__label" for="schedule_end">End Time (hh:mm)</label>
							</div>
							<button id="schedule_btn" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored wid90">Add/Update Schedule</button>
			 		</div>
			 		<div class="mdl-cell mdl-cell--7-col">
			 			<h3>Power Schedule Management</h3>
			 			<div class="mdl-grid" style="text-align: left;">
			 				<div class="mdl-cell mdl-cell--6-col">
			 					<label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="tg_lone">
									<span class="mdl-switch__label">1st Light</span>
								  	<input type="checkbox" id="tg_lone" class="mdl-switch__input">
								</label>
								<label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="tg_fone">
									<span class="mdl-switch__label">1st Fan</span>
								  	<input type="checkbox" id="tg_fone" class="mdl-switch__input">
								</label>
								<label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="tg_pump">
									<span class="mdl-switch__label">Pump</span>
								  	<input type="checkbox" id="tg_pump" class="mdl-switch__input">
								</label>
			 				</div>
			 				<div class="mdl-cell mdl-cell--6-col">
			 					<label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="tg_ltwo">
									<span class="mdl-switch__label">2nd Light</span>
								  	<input type="checkbox" id="tg_ltwo" class="mdl-switch__input">
								</label>
								<label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="tg_ftwo">
									<span class="mdl-switch__label">2nd Fan</span>
								  	<input type="checkbox" id="tg_ftwo" class="mdl-switch__input">
								</label>
			 				</div>
			 			</div>	
			 			<span style="font-size: 20px;font-weight: 100;">Toogle Switches to turn on/off Scheduling...</span>
			 			<button id="schedule_tog" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored wid90">Save Toggles</button>
			 			<button id="schedule_show" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored wid90">Show Schedules</button>	
			 		</div>
				 </div>
				 <div class="demo-card-wide mdl-card mdl-shadow--2dp wid90" id= "tabSchedule" style="overflow-x:auto;margin-top:10px; padding: 10px;">
				 	<h3 >Power Schedule Management Details</h3>
				 	<table class="mdl-data-table mdl-js-data-table" style="width:100%;">
						<thead>
						   	<tr>
							   <th class="mdl-data-table__cell--non-numeric">Device</th>
							   <th class="mdl-data-table__cell--non-numeric">Status</th>
							   <th class="mdl-data-table__cell--non-numeric">Day</th>
							   <th class="mdl-data-table__cell--non-numeric">Start (hh:mm)</th>
							   <th class="mdl-data-table__cell--non-numeric">Stop (hh:mm)</th>
							   <th class="mdl-data-table__cell--non-numeric">Enable</th>
							</tr>
						</thead>
								  <tbody id="myTable2">
								  </tbody>
					</table>
				 </div>
				<div class="demo-card-wide mdl-card mdl-shadow--2dp" style="margin-top:10px;">
				 	<div class='mdl-grid'>
				 		<div class="mdl-cell mdl-cell--3-col">
			 			<div class="calories-square mdl-card mdl-shadow--2dp">
						  <div class="mdl-card__title mdl-card--expand">
						    <h2 class="mdl-card__title-text"></h2>
						  </div>
						  <div class="mdl-card__actions mdl-card--border">
						    <a id = "dietPage" class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
						      DIET Monitor
						    </a>
						  </div>
						</div>
				 		</div>
				 		<div class="mdl-cell mdl-cell--3-col">
				 		<div class="profile-square mdl-card mdl-shadow--2dp">
						  <div class="mdl-card__title mdl-card--expand">
						    <h2 class="mdl-card__title-text"></h2>
						  </div>
						  <div class="mdl-card__actions mdl-card--border">
						    <a id = "profilePage" class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
						      Profile Updater
						    </a>
						  </div>
						</div>
				 		</div>
				 		<div class="mdl-cell mdl-cell--3-col">
				 		<div class="power-square mdl-card mdl-shadow--2dp">
						  <div class="mdl-card__title mdl-card--expand">
						    <h2 class="mdl-card__title-text"></h2>
						  </div>
						  <div class="mdl-card__actions mdl-card--border">
						    <a id = "powerPage" class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
						      Power Monitor
						    </a>
						  </div>
						</div>
				 		</div>
				 		<div class="mdl-cell mdl-cell--3-col">
				 		<div class="chat-square mdl-card mdl-shadow--2dp">
						  <div class="mdl-card__title mdl-card--expand">
						    <h2 class="mdl-card__title-text"></h2>
						  </div>
						  <div class="mdl-card__actions mdl-card--border">
						    <a id = "natashaPage" class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
						      Talk to Natasha
						    </a>
						  </div>
						</div>
				 		</div>
				 	</div>
				</div>
				 
				<div id="toast" class="mdl-js-snackbar mdl-snackbar">
				  <div class="mdl-snackbar__text"></div>
				  <button class="mdl-snackbar__action" type="button"></button>
				</div>
				<script type="text/javascript">
			 		//var name="",status="";
					function snack(string) {
					    var snackbarContainer = document.querySelector('#toast');
					    var data = { message: string, timeout: 2000 };
					    snackbarContainer.MaterialSnackbar.showSnackbar(data);
					}

					function diffTime(a,b)
					{
						a=a.split(':');
						b=b.split(':');
						a=Number(a[0])*60+Number(a[1]);
						b=Number(b[0])*60+Number(b[1]);
						hr=Math.floor((a-b)/60);
						min=Math.floor((a-b)%60);
						if(hr<10)
							hr="0"+hr;
						if(min<10)
							min="0"+min;
						return hr+':'+min;
					}

					function fetchMilli(a)
					{
						a=a.split(':');
						return Number(a[0])*60+Number(a[1]);
					}

					function milliTime(a)
					{
						hr=Math.floor(a/60);
						min=Math.floor(a%60);
						if(hr<10)
							hr="0"+hr;
						if(min<10)
							min="0"+min;
						return hr+'h, '+min+'m';
					}

					function checkM(ar, a)
					{
						for(i=0;i<ar.length;i++)
						{
							if(ar[i]==a)
								return true;
						}
						return false;
					}

					function retDay(a)
					{
						var fdays=[["Monday","mon"],["Tuesday","tue"],["Wednesday","wed"],["Thursday","thur"],["Friday","fri"],["Saturday","sat"],["Sunday","sun"],["Everyday","all"]];
						for(i=0;i<fdays.length;i++)
						{
							if(fdays[i][1]==a)
							{
								return fdays[i][0];
							}
						}
					}

					function retDev(a)
					{
						var fdevs=[["1st Light","lone"],["2nd Light","ltwo"],["1st Fan","fone"],["2nd Fan","ftwo"],["Pump","pump"]];
						for(i=0;i<fdevs.length;i++)
						{
							if(fdevs[i][1]==a)
							{
								return fdevs[i][0];
							}
						}
					}

					$(document).ready(function(){
						
						var url="http://localhost/natasha/server/index.php?schedules";
						$.getJSON(url,function(result){
							$.each(result, function(i, field){
								if(field.sid=="lone" && field.chk=="YES")
									$('#tg_lone').attr( 'checked', true );
								if(field.sid=="fone" && field.chk=="YES")
									$('#tg_fone').attr( 'checked', true );
								if(field.sid=="ltwo" && field.chk=="YES")
									$('#tg_ltwo').attr( 'checked', true );
								if(field.sid=="ftwo" && field.chk=="YES")
									$('#tg_ftwo').attr( 'checked', true );
								if(field.sid=="pump" && field.chk=="YES")
									$('#tg_pump').attr( 'checked', true );
							});
						});

					$("#graph").click(function(){
						$('#stats').html("");
						$('.myLoader').show();
						$('#tabData').show();
						if(enDate == "")
							var url="http://localhost/natasha/server/index.php?date1="+stDate;
						else
							var url="http://localhost/natasha/server/index.php?date1="+stDate+"&date2="+enDate;
					    var block = document.getElementById("myTable1");
					    block.innerHTML ="";
					    var label=[],arr=[],dur=[],dmin=[];
				     	$.getJSON(url,function(result){
						//alert(result.LOne+result.FOne+result.LTwo+result.FTwo+result.FThree+"test");
					  		$.each(result, function(i, field){
					  			var ontime = diffTime(field.stop, field.start)
					  			var ab = [retDev(field.sid) , ontime];
					  			arr.push(ab);
					  			var ab = "<tr><td class='mdl-data-table__cell--non-numeric'>"+field.datel+"</td>" + 
								    					"<td class='mdl-data-table__cell--non-numeric'>"+retDev(field.sid)+"</td>" +
								    					"<td class='mdl-data-table__cell--non-numeric'>"+field.start+"</td>" +
								    					"<td class='mdl-data-table__cell--non-numeric'>"+field.stop+"</td>" +
								       					"<td class='mdl-data-table__cell--non-numeric'>"+ontime.substr(0,ontime.indexOf(':'))+"h "+ontime.substr(ontime.indexOf(':')+1)+"m</td></tr>";
								block.innerHTML +=ab;
					  			
					  		});
					  		for (j=0;j<arr.length;j++)
					  		{
					  			if(!checkM(label,arr[j][0]))
					  				label.push(arr[j][0]);
					  		}
					  		
					  		for(i=0;i<label.length;i++)
					  		{
					  			sum = 0;
					  			for(j=0;j<arr.length;j++)
					  			{
					  				if(label[i]==arr[j][0])
					  				{
					  					sum+=fetchMilli(arr[j][1]);
					  				}
					  			}
					  			dmin.push(sum)
					  			dur.push(milliTime(sum));
					  		}
					  		//lock.innerHTML += arr+"<br/>"+label+"<br/>"+dur+"<br/>"+dmin;
					  	    $('.myLoader').hide();
					  	    //Assigning X and Y axes to the data var, and plotting the graph.
					      	var data = [{
							  x: label,
							  y: dmin,
							  type: 'bar'
							}];

							var annotationContent = [];
							
							var layout = {
							  title: 'Power Consumption Details (Mins/Dev)',
							  annotations: annotationContent
							};
							for( var i = 0 ; i < label.length ; i++ ){
							  var result = {
							    x: label[i],
							    y: dmin[i],
							    text: dur[i],
							    xanchor: 'center',
							    yanchor: 'bottom',
							    showarrow: false
							  };
							  annotationContent.push(result);
							}

								Plotly.newPlot('stats', data,layout);
					  });
					});

					
						
					$('#schedule_btn').click(function(){

						var url="http://localhost/natasha/server/index.php?sid="+document.getElementById('sid').value+"&day="+document.getElementById('day').value+"&stime="+document.getElementById('schedule_start').value+"&etime="+document.getElementById('schedule_end').value+"&status="+document.getElementById('devSt').value;
						$.getJSON(url,function(result){
							if(result.check=='True')
								snack('Scheduled Succesfully !');
							else
								snack('Failed !');
						});
					});

					$('#schedule_show').click(function()
					{
						$('#tabSchedule').show();
						var url="http://localhost/natasha/server/index.php?schedules";
						var tab = document.getElementById('myTable2');
						tab.innerHTML ="";
						$.getJSON(url,function(result){
							$.each(result, function(i, field){
								var ab = "<tr><td class='mdl-data-table__cell--non-numeric'>"+retDev(field.sid)+"</td>" + 
								    					"<td class='mdl-data-table__cell--non-numeric'>"+field.status+"</td>" +
								    					"<td class='mdl-data-table__cell--non-numeric'>"+retDay(field.day)+"</td>" +
								    					"<td class='mdl-data-table__cell--non-numeric'>"+field.stime+"</td>" +
								    					"<td class='mdl-data-table__cell--non-numeric'>"+field.etime+"</td>" +
								       					"<td class='mdl-data-table__cell--non-numeric'>"+field.chk+"</td></tr>";
								tab.innerHTML +=ab;
							});
						});
					});

					$('#schedule_tog').click(function(){
						var serial = "";
						if($('#tg_lone').is(':checked'))
							serial+=1;
						else
							serial+=0;
						if($('#tg_fone').is(':checked'))
							serial+=1;
						else
							serial+=0;
						if($('#tg_ltwo').is(':checked'))
							serial+=1;
						else
							serial+=0;
						if($('#tg_ftwo').is(':checked'))
							serial+=1;
						else
							serial+=0;
						if($('#tg_pump').is(':checked'))
							serial+=1;
						else
							serial+=0;
						var url="http://localhost/natasha/server/index.php?serial="+serial;
						$.getJSON(url,function(result){
							if(result.check=='True')
								snack('Toggled Succesfully !');
							else
								snack('Failed !');
						});
					});

					$("#welcome").html("Welcome "+localStorage.getItem('user'));
					$("#logout").click(function(){
						localStorage.setItem("login","False");
						snack('Please Wait');
						window.open("index.html","_parent");
					});
					$("#powerPage").click(function(){
						snack('Please Wait');
						window.open("power.html","_self");
					});
					$("#profilePage").click(function(){
						snack('Please Wait');
						window.open("profile.html","_self");
					});
					$("#dietPage").click(function(){
						snack('Please Wait');
						window.open("diet.html","_self");
					});
					$("#natashaPage").click(function(){
						snack('Please Wait');
						window.open("msg.html","_self");
					});
				});
				</script>
	    	</center>
	    </div>
	  </main>
	</div>
</body>
</html>
